from web3 import Web3
from web3._utils.events import get_event_data
import asyncio
import json

import twitter

w3 = Web3(Web3.HTTPProvider("https://polygon-rpc.com"))
address = Web3.toChecksumAddress('0x86935f11c86623dec8a25696e1c19a8659cbf95d')
abi = "[{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"uint32\",\"name\":\"listingId\",\"type\":\"uint32\"}],\"name\":\"GotchiLendingAdd\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"uint32\",\"name\":\"listingId\",\"type\":\"uint32\"}],\"name\":\"GotchiLendingEnd\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"uint32\",\"name\":\"listingId\",\"type\":\"uint32\"}],\"name\":\"GotchiLendingExecute\",\"type\":\"event\"},{\"inputs\":[{\"internalType\":\"uint32\",\"name\":\"_erc721TokenId\",\"type\":\"uint32\"},{\"internalType\":\"uint96\",\"name\":\"_initialCost\",\"type\":\"uint96\"},{\"internalType\":\"uint32\",\"name\":\"_period\",\"type\":\"uint32\"},{\"internalType\":\"uint8[3]\",\"name\":\"_revenueSplit\",\"type\":\"uint8[3]\"},{\"internalType\":\"address\",\"name\":\"_originalOwner\",\"type\":\"address\"},{\"internalType\":\"address\",\"name\":\"_thirdParty\",\"type\":\"address\"},{\"internalType\":\"uint32\",\"name\":\"_whitelistId\",\"type\":\"uint32\"},{\"internalType\":\"address[]\",\"name\":\"_revenueTokens\",\"type\":\"address[]\"}],\"name\":\"addGotchiLending\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint32\",\"name\":\"_listingId\",\"type\":\"uint32\"},{\"internalType\":\"uint32\",\"name\":\"_erc721TokenId\",\"type\":\"uint32\"},{\"internalType\":\"uint96\",\"name\":\"_initialCost\",\"type\":\"uint96\"},{\"internalType\":\"uint32\",\"name\":\"_period\",\"type\":\"uint32\"},{\"internalType\":\"uint8[3]\",\"name\":\"_revenueSplit\",\"type\":\"uint8[3]\"}],\"name\":\"agreeGotchiLending\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address[]\",\"name\":\"tokens\",\"type\":\"address[]\"}],\"name\":\"allowRevenueTokens\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint32\",\"name\":\"_listingId\",\"type\":\"uint32\"}],\"name\":\"cancelGotchiLending\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint32\",\"name\":\"_erc721TokenId\",\"type\":\"uint32\"}],\"name\":\"cancelGotchiLendingByToken\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint32\",\"name\":\"_tokenId\",\"type\":\"uint32\"}],\"name\":\"claimAndEndGotchiLending\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint32\",\"name\":\"_tokenId\",\"type\":\"uint32\"}],\"name\":\"claimGotchiLending\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address[]\",\"name\":\"tokens\",\"type\":\"address[]\"}],\"name\":\"disallowRevenueTokens\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint32[]\",\"name\":\"_listingIds\",\"type\":\"uint32[]\"},{\"internalType\":\"address[]\",\"name\":\"_revenueTokens\",\"type\":\"address[]\"}],\"name\":\"emergencyChangeRevenueTokens\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint32\",\"name\":\"_erc721TokenId\",\"type\":\"uint32\"}],\"name\":\"getGotchiLendingFromToken\",\"outputs\":[{\"components\":[{\"internalType\":\"address\",\"name\":\"lender\",\"type\":\"address\"},{\"internalType\":\"uint96\",\"name\":\"initialCost\",\"type\":\"uint96\"},{\"internalType\":\"address\",\"name\":\"borrower\",\"type\":\"address\"},{\"internalType\":\"uint32\",\"name\":\"listingId\",\"type\":\"uint32\"},{\"internalType\":\"uint32\",\"name\":\"erc721TokenId\",\"type\":\"uint32\"},{\"internalType\":\"uint32\",\"name\":\"whitelistId\",\"type\":\"uint32\"},{\"internalType\":\"address\",\"name\":\"originalOwner\",\"type\":\"address\"},{\"internalType\":\"uint40\",\"name\":\"timeCreated\",\"type\":\"uint40\"},{\"internalType\":\"uint40\",\"name\":\"timeAgreed\",\"type\":\"uint40\"},{\"internalType\":\"bool\",\"name\":\"canceled\",\"type\":\"bool\"},{\"internalType\":\"bool\",\"name\":\"completed\",\"type\":\"bool\"},{\"internalType\":\"address\",\"name\":\"thirdParty\",\"type\":\"address\"},{\"internalType\":\"uint8[3]\",\"name\":\"revenueSplit\",\"type\":\"uint8[3]\"},{\"internalType\":\"uint40\",\"name\":\"lastClaimed\",\"type\":\"uint40\"},{\"internalType\":\"uint32\",\"name\":\"period\",\"type\":\"uint32\"},{\"internalType\":\"address[]\",\"name\":\"revenueTokens\",\"type\":\"address[]\"}],\"internalType\":\"struct GotchiLending\",\"name\":\"listing_\",\"type\":\"tuple\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint32\",\"name\":\"_erc721TokenId\",\"type\":\"uint32\"}],\"name\":\"getGotchiLendingIdByToken\",\"outputs\":[{\"internalType\":\"uint32\",\"name\":\"\",\"type\":\"uint32\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint32\",\"name\":\"_listingId\",\"type\":\"uint32\"}],\"name\":\"getGotchiLendingListingInfo\",\"outputs\":[{\"components\":[{\"internalType\":\"address\",\"name\":\"lender\",\"type\":\"address\"},{\"internalType\":\"uint96\",\"name\":\"initialCost\",\"type\":\"uint96\"},{\"internalType\":\"address\",\"name\":\"borrower\",\"type\":\"address\"},{\"internalType\":\"uint32\",\"name\":\"listingId\",\"type\":\"uint32\"},{\"internalType\":\"uint32\",\"name\":\"erc721TokenId\",\"type\":\"uint32\"},{\"internalType\":\"uint32\",\"name\":\"whitelistId\",\"type\":\"uint32\"},{\"internalType\":\"address\",\"name\":\"originalOwner\",\"type\":\"address\"},{\"internalType\":\"uint40\",\"name\":\"timeCreated\",\"type\":\"uint40\"},{\"internalType\":\"uint40\",\"name\":\"timeAgreed\",\"type\":\"uint40\"},{\"internalType\":\"bool\",\"name\":\"canceled\",\"type\":\"bool\"},{\"internalType\":\"bool\",\"name\":\"completed\",\"type\":\"bool\"},{\"internalType\":\"address\",\"name\":\"thirdParty\",\"type\":\"address\"},{\"internalType\":\"uint8[3]\",\"name\":\"revenueSplit\",\"type\":\"uint8[3]\"},{\"internalType\":\"uint40\",\"name\":\"lastClaimed\",\"type\":\"uint40\"},{\"internalType\":\"uint32\",\"name\":\"period\",\"type\":\"uint32\"},{\"internalType\":\"address[]\",\"name\":\"revenueTokens\",\"type\":\"address[]\"}],\"internalType\":\"struct GotchiLending\",\"name\":\"listing_\",\"type\":\"tuple\"},{\"components\":[{\"internalType\":\"uint256\",\"name\":\"tokenId\",\"type\":\"uint256\"},{\"internalType\":\"string\",\"name\":\"name\",\"type\":\"string\"},{\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"randomNumber\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"status\",\"type\":\"uint256\"},{\"internalType\":\"int16[6]\",\"name\":\"numericTraits\",\"type\":\"int16[6]\"},{\"internalType\":\"int16[6]\",\"name\":\"modifiedNumericTraits\",\"type\":\"int16[6]\"},{\"internalType\":\"uint16[16]\",\"name\":\"equippedWearables\",\"type\":\"uint16[16]\"},{\"internalType\":\"address\",\"name\":\"collateral\",\"type\":\"address\"},{\"internalType\":\"address\",\"name\":\"escrow\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"stakedAmount\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"minimumStake\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"kinship\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"lastInteracted\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"experience\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"toNextLevel\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"usedSkillPoints\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"level\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"hauntId\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"baseRarityScore\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"modifiedRarityScore\",\"type\":\"uint256\"},{\"internalType\":\"bool\",\"name\":\"locked\",\"type\":\"bool\"},{\"components\":[{\"internalType\":\"uint256\",\"name\":\"balance\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"itemId\",\"type\":\"uint256\"},{\"components\":[{\"internalType\":\"string\",\"name\":\"name\",\"type\":\"string\"},{\"internalType\":\"string\",\"name\":\"description\",\"type\":\"string\"},{\"internalType\":\"string\",\"name\":\"author\",\"type\":\"string\"},{\"internalType\":\"int8[6]\",\"name\":\"traitModifiers\",\"type\":\"int8[6]\"},{\"internalType\":\"bool[16]\",\"name\":\"slotPositions\",\"type\":\"bool[16]\"},{\"internalType\":\"uint8[]\",\"name\":\"allowedCollaterals\",\"type\":\"uint8[]\"},{\"components\":[{\"internalType\":\"uint8\",\"name\":\"x\",\"type\":\"uint8\"},{\"internalType\":\"uint8\",\"name\":\"y\",\"type\":\"uint8\"},{\"internalType\":\"uint8\",\"name\":\"width\",\"type\":\"uint8\"},{\"internalType\":\"uint8\",\"name\":\"height\",\"type\":\"uint8\"}],\"internalType\":\"struct Dimensions\",\"name\":\"dimensions\",\"type\":\"tuple\"},{\"internalType\":\"uint256\",\"name\":\"ghstPrice\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"maxQuantity\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"totalQuantity\",\"type\":\"uint256\"},{\"internalType\":\"uint32\",\"name\":\"svgId\",\"type\":\"uint32\"},{\"internalType\":\"uint8\",\"name\":\"rarityScoreModifier\",\"type\":\"uint8\"},{\"internalType\":\"bool\",\"name\":\"canPurchaseWithGhst\",\"type\":\"bool\"},{\"internalType\":\"uint16\",\"name\":\"minLevel\",\"type\":\"uint16\"},{\"internalType\":\"bool\",\"name\":\"canBeTransferred\",\"type\":\"bool\"},{\"internalType\":\"uint8\",\"name\":\"category\",\"type\":\"uint8\"},{\"internalType\":\"int16\",\"name\":\"kinshipBonus\",\"type\":\"int16\"},{\"internalType\":\"uint32\",\"name\":\"experienceBonus\",\"type\":\"uint32\"}],\"internalType\":\"struct ItemType\",\"name\":\"itemType\",\"type\":\"tuple\"}],\"internalType\":\"struct ItemTypeIO[]\",\"name\":\"items\",\"type\":\"tuple[]\"}],\"internalType\":\"struct AavegotchiInfo\",\"name\":\"aavegotchiInfo_\",\"type\":\"tuple\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"bytes32\",\"name\":\"_status\",\"type\":\"bytes32\"},{\"internalType\":\"uint256\",\"name\":\"_length\",\"type\":\"uint256\"}],\"name\":\"getGotchiLendings\",\"outputs\":[{\"components\":[{\"internalType\":\"address\",\"name\":\"lender\",\"type\":\"address\"},{\"internalType\":\"uint96\",\"name\":\"initialCost\",\"type\":\"uint96\"},{\"internalType\":\"address\",\"name\":\"borrower\",\"type\":\"address\"},{\"internalType\":\"uint32\",\"name\":\"listingId\",\"type\":\"uint32\"},{\"internalType\":\"uint32\",\"name\":\"erc721TokenId\",\"type\":\"uint32\"},{\"internalType\":\"uint32\",\"name\":\"whitelistId\",\"type\":\"uint32\"},{\"internalType\":\"address\",\"name\":\"originalOwner\",\"type\":\"address\"},{\"internalType\":\"uint40\",\"name\":\"timeCreated\",\"type\":\"uint40\"},{\"internalType\":\"uint40\",\"name\":\"timeAgreed\",\"type\":\"uint40\"},{\"internalType\":\"bool\",\"name\":\"canceled\",\"type\":\"bool\"},{\"internalType\":\"bool\",\"name\":\"completed\",\"type\":\"bool\"},{\"internalType\":\"address\",\"name\":\"thirdParty\",\"type\":\"address\"},{\"internalType\":\"uint8[3]\",\"name\":\"revenueSplit\",\"type\":\"uint8[3]\"},{\"internalType\":\"uint40\",\"name\":\"lastClaimed\",\"type\":\"uint40\"},{\"internalType\":\"uint32\",\"name\":\"period\",\"type\":\"uint32\"},{\"internalType\":\"address[]\",\"name\":\"revenueTokens\",\"type\":\"address[]\"}],\"internalType\":\"struct GotchiLending[]\",\"name\":\"listings_\",\"type\":\"tuple[]\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint32\",\"name\":\"_listingId\",\"type\":\"uint32\"}],\"name\":\"getLendingListingInfo\",\"outputs\":[{\"components\":[{\"internalType\":\"address\",\"name\":\"lender\",\"type\":\"address\"},{\"internalType\":\"uint96\",\"name\":\"initialCost\",\"type\":\"uint96\"},{\"internalType\":\"address\",\"name\":\"borrower\",\"type\":\"address\"},{\"internalType\":\"uint32\",\"name\":\"listingId\",\"type\":\"uint32\"},{\"internalType\":\"uint32\",\"name\":\"erc721TokenId\",\"type\":\"uint32\"},{\"internalType\":\"uint32\",\"name\":\"whitelistId\",\"type\":\"uint32\"},{\"internalType\":\"address\",\"name\":\"originalOwner\",\"type\":\"address\"},{\"internalType\":\"uint40\",\"name\":\"timeCreated\",\"type\":\"uint40\"},{\"internalType\":\"uint40\",\"name\":\"timeAgreed\",\"type\":\"uint40\"},{\"internalType\":\"bool\",\"name\":\"canceled\",\"type\":\"bool\"},{\"internalType\":\"bool\",\"name\":\"completed\",\"type\":\"bool\"},{\"internalType\":\"address\",\"name\":\"thirdParty\",\"type\":\"address\"},{\"internalType\":\"uint8[3]\",\"name\":\"revenueSplit\",\"type\":\"uint8[3]\"},{\"internalType\":\"uint40\",\"name\":\"lastClaimed\",\"type\":\"uint40\"},{\"internalType\":\"uint32\",\"name\":\"period\",\"type\":\"uint32\"},{\"internalType\":\"address[]\",\"name\":\"revenueTokens\",\"type\":\"address[]\"}],\"internalType\":\"struct GotchiLending\",\"name\":\"listing_\",\"type\":\"tuple\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"_lender\",\"type\":\"address\"},{\"internalType\":\"bytes32\",\"name\":\"_status\",\"type\":\"bytes32\"},{\"internalType\":\"uint256\",\"name\":\"_length\",\"type\":\"uint256\"}],\"name\":\"getOwnerGotchiLendings\",\"outputs\":[{\"components\":[{\"internalType\":\"address\",\"name\":\"lender\",\"type\":\"address\"},{\"internalType\":\"uint96\",\"name\":\"initialCost\",\"type\":\"uint96\"},{\"internalType\":\"address\",\"name\":\"borrower\",\"type\":\"address\"},{\"internalType\":\"uint32\",\"name\":\"listingId\",\"type\":\"uint32\"},{\"internalType\":\"uint32\",\"name\":\"erc721TokenId\",\"type\":\"uint32\"},{\"internalType\":\"uint32\",\"name\":\"whitelistId\",\"type\":\"uint32\"},{\"internalType\":\"address\",\"name\":\"originalOwner\",\"type\":\"address\"},{\"internalType\":\"uint40\",\"name\":\"timeCreated\",\"type\":\"uint40\"},{\"internalType\":\"uint40\",\"name\":\"timeAgreed\",\"type\":\"uint40\"},{\"internalType\":\"bool\",\"name\":\"canceled\",\"type\":\"bool\"},{\"internalType\":\"bool\",\"name\":\"completed\",\"type\":\"bool\"},{\"internalType\":\"address\",\"name\":\"thirdParty\",\"type\":\"address\"},{\"internalType\":\"uint8[3]\",\"name\":\"revenueSplit\",\"type\":\"uint8[3]\"},{\"internalType\":\"uint40\",\"name\":\"lastClaimed\",\"type\":\"uint40\"},{\"internalType\":\"uint32\",\"name\":\"period\",\"type\":\"uint32\"},{\"internalType\":\"address[]\",\"name\":\"revenueTokens\",\"type\":\"address[]\"}],\"internalType\":\"struct GotchiLending[]\",\"name\":\"listings_\",\"type\":\"tuple[]\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint32\",\"name\":\"_erc721TokenId\",\"type\":\"uint32\"}],\"name\":\"isAavegotchiLent\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"token\",\"type\":\"address\"}],\"name\":\"revenueTokenAllowed\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"stateMutability\":\"view\",\"type\":\"function\"}]"
abi = json.loads(abi)
contract = w3.eth.contract(address=address, abi=abi)
event_template = contract.events.GotchiLendingAdd

listPrinted = []

def handle_event(event, event_template):
    try:
        result = get_event_data(event_template.web3.codec, event_template._get_event_abi(), event)
        return True, result
    except:
        return False, None

async def go():
    while 1:
        events = w3.eth.get_logs({'fromBlock': 'latest', 'address': address})
        for event in events:
            suc, res = handle_event(event=event, event_template=event_template)
            if suc:
                listingId = res['args']['listingId']
                listingInfo = contract.functions.getGotchiLendingListingInfo(listingId).call()
                owner = listingInfo[0][0]
                initialCost = listingInfo[0][1] / (pow(10, 18))
                initialCost = "free!" if initialCost <= 0 else initialCost
                gotchiId = listingInfo[0][3]
                ownerPercent = listingInfo[0][12][0]
                borrowerPercent = listingInfo[0][12][1]
                otherPercent = listingInfo[0][12][2]
                gotchiBRS = listingInfo[1][19]
                gotchiName = listingInfo[1][1]
                gotchiName = (gotchiName[:15] + '..') if len(gotchiName) > 15 else gotchiName
                timeLend = listingInfo[0][14] / 3600
                if listingId not in listPrinted:
                    listPrinted.append(listingId)
                    print(f"New gotchi {gotchiName} for lend id: {listingId} time : {timeLend}! initial price: {initialCost}, percentages: {ownerPercent} {borrowerPercent} {otherPercent}, BRS = {gotchiBRS}")
                    twitter.send_message(listingId, initialCost, ownerPercent, borrowerPercent, otherPercent, gotchiBRS, gotchiName, timeLend)
        await asyncio.sleep(2)

def start():
    try:
        loop = asyncio.get_event_loop()
        loop.run_until_complete(asyncio.gather(go()))
    finally:
        start()

if __name__ == '__main__':
    start()